{% extends "base_form.html" %}

{% block title %}{{super()}} - Series Explorer{% endblock %}

{% block styles %}
    {{super()}}
    <style>
    #infos td {
    	font-size: 90%;
    }
    </style>
{% endblock %}

{% block page %}

<div class="container-fluid">

	<div class="row">
		<div class="col-md-2">
			<div class="row">
				<div class="col-md-12">
					<div class="panel panel-default">
				    	<div class="panel-body">
				    			    	
							<form id="search_form">
							
								<div class="form-group">
									<label class="control-label" for="limit">Limit:</label>
									<select id="limit" name="limit" class="form-control input-sm">
										<option value="50">50</option>
										<option value="100" selected="true">100</option>
										<option value="200">200</option>
										<option value="500">500</option>
										<option value="1000">1000</option>
									</select>
								</div>
								
								<div class="form-group">
									<label class="control-label" for="provider">Provider:</label>
									<select id="provider" name="provider" class="form-control input-sm chosen-select"></select>
								</div>
							
								<div class="form-group">
									<label class="control-label" for="dataset">Dataset:</label>
									<select id="dataset" name="dataset" class="form-control input-sm chosen-select"></select>
								</div>
								
							</form>
							
				    	</div>
				    </div>
				</div>
			</div>		
		</div>
		
		<div class="col-md-10">
			<div class="row">
				<div class="col-md-12">
				
		    		<table id="infos" class="table table-condensed">
		    			<tbody>
		    				<tr>
		    					<td class="col-md-1 info">Count</td>
		    					<td class="col-md-3">
		    						<span id="total_series" class="human-number">0</span>
		    					</td>
		    					<td class="col-md-1 active">JSON Api</td>
		    					<td class="col-md-7">
		    						<small><a href="" id="jsonURL">Select an provider and an dataset for completed URL !</a></small>
		    					</td>
		    				</tr>
		    				<tr>
		    					<td class="col-md-1 info">Provider</td>
		    					<td class="col-md-3">
		    						<span id="selectedProvider">All</span>
		    					</td>
		    					<td class="col-md-1 active">SDMX Api</td>
		    					<td class="col-md-7">
		    						<small><a href="" id="sdmxURL">Select an provider and an dataset for completed URL !</a></small>
		    					</td>
		    				</tr>
		    				<tr>
		    					<td class="col-md-1 info">Dataset</td>
		    					<td class="col-md-3">
		    						<span id="selectedDataset">All</span>
		    					</td>
		    					<td class="col-md-1">&nbsp;</td>
		    					<td class="col-md-7">
		    						<small>&nbsp;</small>
		    					</td>
		    					{#
		    					<td class="col-md-1 active">HTML Api</td>
		    					<td class="col-md-7">
		    						<small><a href="" id="htmlURL">Select an provider and an dataset for completed URL !</a></small>
		    					</td>
		    					#}
		    				</tr>
		    			</tbody>
		    		</table>
			    </div>
			</div>
			
			<div class="row">
			    <div class="col-md-12">

				<div class="panel panel-default">
				
					<table class="table" id="series-list" 
						data-classes="table table-hover table-condensed"   
	        			data-striped="true" 
	        			data-mobile-responsive="true"
				        data-buttons-align="left"
				        data-toolbar-align="right"
				        data-pagination-h-align="left"
				        data-pagination-detail-h-align="right"
				        data-pagination-v-align="top"
				        data-pagination="true" 
				        data-page-size="{{ page_size|default('10') }}"
				        data-page-list="[10, 25, 50, 100]"  
						>
					<thead>
					    <tr>
					    
			                <th class="col-md-1" data-field="key" data-formatter="seriesButtonFormatter">&nbsp;</th>
			                {#
			                <th class="col-md-1" data-field="view" data-formatter="seriesLinkFormatter">&nbsp;</th>
			                <th class="col-md-1" data-field="slug" data-formatter="addCartFormatter">&nbsp;</th>
			                #}
				            <th class="col-md-1" data-field="provider_name" data-sortable="true">Provider</th>
				            <th class="col-md-1" data-field="dataset_code" data-sortable="true">Dataset</th>
			                <th class="col-md-2" data-field="key" data-formatter="seriesKeyLinkFormatter" data-sortable="true">key</th>
			                <th class="col-md-4" data-field="name" data-sortable="true">Name</th>
			                <th class="col-md-1" data-field="frequency" data-align="center" data-sortable="true" data-title-tooltip="Frequency">Freq</th>
				            <th class="col-md-1" data-field="start_date" data-align="center" data-sortable="true" data-filter-control="input">Start Date</th>                         
				            <th class="col-md-1" data-field="end_date" data-align="center" data-sortable="true">End Date</th>
					    	
						</tr>
					</thead>
					</table>
				</div>
			</div>		
		</div>
	</div>
</div>
    

{% endblock page %}


{% block scripts %}
    {{super()}}

	<script id="template-select" type="x-tmpl-mustache">
		{% raw %}
		<div class="form-group" id="form_group_{{key}}">
			<label class="control-label" for="{{key}}">{{caption}}:</label>
			<select id="{{key}}" name="{{key}}" class="form-control input-sm chosen-select" multiple="true" data-placeholder="Choose a {{caption}}">
				{#<option value="">Choose a {{caption}}</option>#}
				{{#options}}
				<option value="{{id}}">{{text}}</option>
				{{/options}}
			</select>
		</div>
		{% endraw %}
	</script>

    <script type="text/javascript">
    
    var providers_by_slug = {};
    var datasets_by_slug = {};

    $(document).ready(function(){
    	
		var $table = $('#series-list').bootstrapTable();
		
		var api_no_select_text = "Select an provider and an dataset for completed URL !";

		var limit = $('#limit').val();
		
		var selectedProvider;
		var selectedDataset;
		var dimensionFields = [];
    	
		var template = $('#template-select').html();
    	Mustache.parse(template);
    	
    	$('#limit').chosen();

	    function loadData(){
	  		var url = "{{url_for('.series-all')}}";
	  		var options = {};
	  		
	  		options.limit = limit;
	  		
	  		if (selectedDataset) {
	  			options.dataset = selectedDataset;
	  		}
	  		else if (! _.isEmpty(selectedProvider)) {
	  			options.provider = selectedProvider;
	  		}
	  		
	  		var dimension_filter = [];
	  		var full_dimension_filter = {};
	  		var is_filter = false;
	  		
	  		_.forEach(dimensionFields, function(dim) {
	  			var add_filter;
	  			if (dim.selectedOption){
	  				options['dimensions_' + dim.key] = dim.selectedOption.join(' ');
	  				add_filter = dim.selectedOption.join('+');
	  				if (! _.isEmpty(add_filter) ){
	  					is_filter = true;
	  					full_dimension_filter[dim.key] = add_filter;
	  				}
	  			} else {
	  				add_filter = "";
	  			}
	  			dimension_filter.push(add_filter);
	  		});
	  		
	  		if (! _.isEmpty(selectedDataset)) {
		  		var api_sdmx = ["{{ config.BASE_URL_API_SDMX}}"];
	  			api_sdmx.push(providers_by_slug[selectedProvider]);
	  			api_sdmx.push("data");
	  			api_sdmx.push(datasets_by_slug[selectedDataset]);
	  			if (is_filter){
	  				api_sdmx.push(dimension_filter.join('.').toUpperCase());
	  			}
	  			$("#sdmxURL").attr('href', api_sdmx.join('/'));
	  			$("#sdmxURL").text(api_sdmx.join('/'));

		  		var api_json = ["{{ config.BASE_URL_API_JSON}}"];
		  		api_json.push("datasets");
		  		api_json.push(selectedDataset);
		  		api_json.push("values");
		  		api_json = api_json.join('/');
	  			if (is_filter){
	  				api_json = api_json + '?' + $.param(full_dimension_filter);
	  			}
	  			$("#jsonURL").attr('href', api_json);
	  			$("#jsonURL").text(api_json);
	  			
	  			{#
	  			//http://widukind-api-dev.cepremap.org/api/v1/html/datasets/insee-ipch-2015-fr-coicop/values?frequency=M&produit=10
	  			//http://widukind-api-dev.cepremap.org/api/v1/html/datasets/insee-ipch-2015-fr-coicop/values?frequency=m
	  			//http://widukind-api-dev.cepremap.org/api/v1/html/datasets/bis-pp-ls/values?reference-area=fr+au&frequency=Q
	  			//http://widukind-api-dev.cepremap.org/api/v1/html/datasets/bis-pp-ls/Q/values?reference-area=fr+au
		  		var api_html = ["{{ config.BASE_URL_API_HTML}}"];
		  		api_html.push("datasets");
		  		api_html.push(selectedDataset);
		  		api_html.push("values");
		  		api_html = api_html.join('/');
	  			if (is_filter){
	  				api_html = api_html + '?' + $.param(full_dimension_filter);
	  			}
	  			$("#htmlURL").attr('href', api_html);
	  			$("#htmlURL").text(api_html);
	  			#}
	  			
	  		}
	  		
	  		ajax(url, 'GET', options).done(function(data) {
	        	$table.bootstrapTable('load', data.data);
	        	$("#count_series").text(Humanize.formatNumber(data.data.length));
	            $("#total_series").text(Humanize.formatNumber(data.meta.total));
	  		});
	  		
	  	};
		
		function Provider(data) {
		    this.id = data.slug;
		    this.text = data.name;
		}

		function Dataset(data) {
		    this.id = data.slug;
		    this.text = data.dataset_code;
		}

	  	function loadProviders(){
			var url = '{{ url_for(".ajax-providers-list") }}';
			ajax(url, 'GET').done(function(data) {
	            var providers = $.map(data.data, function(item) { return new Provider(item) });
	            
	            $('#provider').empty().append('<option value="">Select a Provider</option>');
	            _.each(providers, function(item) {
	            	providers_by_slug[item.id] = item.text;
	            	$('#provider').append($("<option></option>").attr("value", item.id).text(item.text));
	            });
	            
	            $('#provider').chosen({allow_single_deselect: true});
			});
	  	};
	  	
	  	function loadDatasets(){
	  		if (_.isEmpty(selectedProvider)){
	  			cleanDataset();
	  			return;
	  		}
	  		
	  		$("#dataset").chosen("destroy");
	  		
			var url = '/views/ajax/providers/'+ selectedProvider +'/datasets';
			ajax(url, 'GET').done(function(data) {
	            var datasets = $.map(data.data, function(item) { return new Dataset(item) });
	            
	            $('#dataset').empty().append('<option value="">Select a Dataset</option>');
	            
	            _.each(datasets, function(item) {
	            	datasets_by_slug[item.id] = item.text;
	            	$('#dataset').append($("<option></option>").attr("value", item.id).text(item.text));
	            });
	            
	            $('#dataset').chosen();
	        });
	  	};

	  	function loadDimensions(){
	  		
	  		if ( _.isEmpty(selectedDataset) ){
	  			cleanDimensions();
	  			return;
	  		}

	  		cleanDimensions();
	  		dimensionFields = new Array()
	  		
			var url = '/views/ajax/datasets/'+ selectedDataset +'/dimensions/all';
			
			ajax(url, 'GET').done(function(data) {
				
				_.forEach(data.data, function(item){
            		var options = [];
            		
            		$.each(item.codes, function(key2, item2){
            			options.push({"id": key2, "text": item2});
            		});
            		
            		var newobj = {
            			"key": item.key,
            			"selectedOption": [],
            			"selectedDataset": selectedDataset,
            			"options": options,
            			"caption": item.name
            		};
            		dimensionFields.push(newobj);
            	});
            	
    			_.forEach(dimensionFields, function(dim) {
    		    	var rendered = Mustache.render(template, dim);
    		        var result = $("#search_form").append(rendered);
    		    });
    			
    			_.forEach(dimensionFields, function(dim) {
    				$("#" + dim.key).chosen("destroy");
    				
    				$("#" + dim.key).chosen({allow_single_deselect: true})
    				.on('change', function() {
    					dim.selectedOption = $(this).val();
    					loadData();
    				});
    			});
    			
			});
			
	  	};

	  	function cleanDataset(){
	  		selectedDataset = null;
	  		$('#dataset').empty().chosen();
	  		$("#selectedDataset").text("All");
	  		dimension_filter = [];
			is_filter = false;
	  	}

	  	function cleanDimensions(){
	  		_.forEach(dimensionFields, function(dim) {
	  			$("#" + dim.key).chosen("destroy");
	  			$("#form_group_" + dim.key).remove();
	  		});
	  		dimensionFields = new Array();
	  		dimension_filter = [];
			is_filter = false;
	  		$("#sdmxURL").text(api_no_select_text);
	  		$("#jsonURL").text(api_no_select_text);
	  		//$("#htmlURL").text(api_no_select_text);
	  	}
	  	
	  	$('#limit').on('change', function() {
	  		limit = this.value;
	  		loadData();
	  	});	
	  	
	  	$('#provider').on('change', function() {
	  		selectedProvider = $(this).val();
	  		cleanDataset();
	  		cleanDimensions();
	  		if (selectedProvider){
	  			$("#selectedProvider").text(providers_by_slug[selectedProvider]);
	  		} else {
	  			$("#selectedProvider").text("All");
	  		}
	  		loadDatasets();
	  		loadData();
	  	});	
	  	
	  	$('#dataset').on('change', function() {	  		
	  		selectedDataset = this.value;
	  		$("#selectedDataset").text(datasets_by_slug[selectedDataset]);
	  		cleanDimensions();
	  		loadDimensions();
	  		loadData();
	  	});	

		loadProviders();
		loadDatasets();
		loadData();
		
	    $("#api-infos").click(function(e){
	        e.preventDefault();
	        $("#api-infos-urls").toggle();
	    });     
		
		
    });
    
    </script>
    
{% endblock %}
    