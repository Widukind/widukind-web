{% extends "layout.html" %}

{% block title %}{{super()}} - Datasets Search{% endblock %}

{% block breadcrumb %}
{% endblock %}

{%- block metas %}
{{super()}}
<meta name="robots" content="noindex, nofollow">
{%- endblock metas %}

{% block styles %}
    {{super()}}
    
    {% include "include/form-css.html" with context %}
    
	<style type="text/css">
	#search_form .col-xs-3, .col-xs-2 {
	   padding-left: 0;
	}		
	</style>

{% endblock %}

{% block menu_left_attrs %}class="col-md-2"{% endblock %}

{% block site_content_attrs %}class="col-md-10"{% endblock %}

{% block menu_left %}
{% include "include/search_form.html" with context %}
{% endblock %}

{% block page %}

<div class="container-fluid">

    <h4>Search result <span id="result_count" class="human-number badge">0</span></h4>

    <table id="datasets" 
        data-toggle="table" 
        data-classes="table table-hover table-condensed"  
        data-striped="true"
        data-mobile-responsive="true"
        data-check-on-init="true"
        
        data-card-view="true"        
        data-show-toggle="true"
        data-show-refresh="false"
        data-show-columns="true"
        data-show-pagination-switch="false" 
        data-flat="true"
        data-search="false"
        data-search-align="left"
        data-buttons-align="left"
        data-toolbar-align="right"
        data-pagination-h-align="left"
        data-pagination-detail-h-align="right"
        data-pagination-v-align="top"

        data-cookie="true"
        data-cookie-id-table="saveId"
        
        data-filter-control="false"
        
        data-striped="true"
        data-pagination="true" 
        data-side-pagination="client"  
        data-page-size="{{ page_size|default('10') }}"
        data-page-list="[10, 25, 50, 100]"  

        data-sort-name="last_update"
        data-sort-order="desc">
        <thead> 
            <tr>
                <th data-field="name" data-formatter="datasetNameFormatter" data-sortable="true">Name</th>
                <th data-field='provider_name' data-sortable="true">Provider</th>
                <th data-field="dataset_code" data-title-tooltip="Dataset Code" data-sortable="true">Dataset</th>
                <th data-field="last_update" data-formatter="datasetLastUpdateFormatter"data-sortable="true">Last Update</th>
            </tr>
        </thead>
    </table>   
</div>

{% endblock %}                                    

{% block add_scripts %}
    {{super()}}

    {% include "include/form-js.html" with context %}
    
    <script type="text/javascript">
        $(document).ready(function(){
        	
        	$("#site_menu_left").show();
        	
        	var $table = $('#datasets');
        	
        	$('.select2-select').select2({
        		placeholder: "Select an option",
        		allowClear: true,
        		closeOnSelect: true,
        		maximumSelectionLength: 1,
        	}).val("ALL").trigger("change");
            
            function load_table(data){
                $table.bootstrapTable('load', data.rows); // client side
                //$table.bootstrapTable('load', data); // server side
            }
            
            var $search_form = $('#search_form').formValidation({
                framework: 'bootstrap',
                excluded: [':disabled', ':hidden', ':not(:visible)'],
                icon: {
                    valid: 'glyphicon glyphicon-ok',
                    invalid: 'glyphicon glyphicon-remove',
                    validating: 'glyphicon glyphicon-refresh'
                },
                live: 'enable',
                /*
                err: {
                    container: 'tooltip'
                },
                */
                fields: {
                    query: {
                        validators: {
                            notEmpty: {
                                message: 'The query is required'
                            },
                            stringLength: {
                                min: 3,
                                //max: 30,
                                message: 'The name must be more than 3 characters long'
                            },
                        }
                    },
                    limit: {
                        validators: {
                            notEmpty: {
                                message: 'The limit is required'
                            },
                            between: {
                                min: {{ config.SEARCH_MIN }},
                                max: {{ config.SEARCH_MAX }},
                                message: 'The limit must be between {{ config.SEARCH_MIN }} and {{ config.SEARCH_MAX }}'
                            }                            
                        }
                    },
                },
            })
            .on('err.field.fv', function(e, data) {
            	data.fv.disableSubmitButtons(false);
            	
            })
            .on('success.field.fv', function(e, data) {
            	data.fv.disableSubmitButtons(false);
            })
            .on('success.form.fv', function(e) {
                e.preventDefault();
                
                var $form = $(e.target);

                $.ajax({
                    url: "{{ url_for("views.search_datasets") }}",
                    type: 'POST',
                    data: $form.serialize(),
                    success: function(result) {
                        
                        $("#result_count").text(result.object_list.length + '/' + result.count);
                        
                        load_table({
                            "total": result.count,
                            "rows": result.object_list
                        });
                    },
                });
            	
            });
            
        });
    </script>
    
{% endblock %}
                                    
                                    
